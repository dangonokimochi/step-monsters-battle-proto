# 戦闘MVP仕様書

## 1. 概要

Step Monstersの戦闘システムプロトタイプ。
簡易スーパーロボット大戦に近いグリッドSRPGを、6×4・4vs4に縮小してSPD順ターン制にしたもの。

### リファレンス作品
- スーパーロボット大戦（グリッド戦闘の基本構造）
- Slay the Spire（ローグライトの緊張感、逃走なし）
- エーテルマンサー / Aethermancer（世界観・トーン・アートの方向性）

### 検証ポイント（優先度順）

**盤面・操作性**
- 6×4グリッドでの位置取り・回り込みは面白いか
- 盤面サイズはモバイルで快適か
- カメラ制御（ズーム＋全体表示）の操作性は快適か
- 4体vs4体で盤面がスカスカにならないか（地形で解決できているか）

**テンポ・時間（最重要）**
- 1戦にかかる時間はどのくらいか
- 「移動を考える→行動を考える」の判断量が重すぎないか
- 散歩の合間に遊ぶゲームとして1戦のテンポは適切か

**戦闘の深み**
- MOVによる移動判断に深みがあるか
- 射程・射線貫通・貫通率の異なるスキル選択に悩みがあるか
- ランダム地形で毎戦違う展開が生まれるか
- MPリソース管理は機能してるか
- 個体差（ステータスの違い）が体感できるか

---

## 2. 盤面

### グリッド
- 6×4マス（24マス）
- 陣営区別なし。戦闘開始後はどのマスにも移動可能
- 座標系：col(0-5, 左→右), row(0-3, 上→下)

### 初期配置
- 味方：col 0〜2（左半分）に自由配置
- 敵：col 3〜5（右半分）に自動配置
- 1マスに1体まで

### 地形
戦闘ごとにランダムで配置。密度はバランス調整で決定（目安：3〜5マス程度に地形を配置）。

| 地形 | 侵入 | 射線 | 効果 |
|------|:--:|:--:|------|
| 平地 | 可 | 通る | 効果なし（デフォルト） |
| 岩 | 不可 | 遮る | 壁として機能 |
| 水たまり | 可 | 通る | 侵入時MOV+1消費 |
| 茂み | 可 | 通る | 中にいると遠距離直射の対象にならない |
| 高台 | 可 | 通る | 高台上のユニットは射程+1 |

---

## 3. ターン制

### 行動順
1. 戦闘開始時、全ユニットをSPD降順でソート
2. SPD順に1体ずつ行動
3. 全ユニットが行動したら1ラウンド終了、次のラウンドへ
4. SPDが同値の場合、味方優先（それも同じならランダム）

### 1ターンの流れ
1. **移動フェーズ**（任意）：MOV消費でグリッド上を移動。スキップ可能
2. **行動フェーズ**（必須）：以下から1つ選択
   - 通常攻撃
   - スキル使用（MP消費）
   - アイテム使用（MVP段階では未実装、将来用のスロット）
   - 待機（何もしない）

※移動→行動の順。行動後に移動はできない。

---

## 4. 移動

### MOV
- モンスター種ごとの固定値（1〜3）
- 1MOV = 隣接1マスへの移動
- 斜め移動は不可（上下左右の4方向）
- 他ユニットが占有するマスには侵入不可
- 水たまりマスに入るとMOV+1消費

### 移動範囲の計算
- 開始マスからMOV以内で到達可能なマスをBFSで算出
- 障害物（岩、他ユニット）を迂回する経路を考慮

---

## 5. 攻撃・スキル

### 技の構成
- 各モンスターは通常攻撃 + 最大4つのスキルを持つ
- モンスターによってスキル数は異なる（1〜4つ）
- 通常攻撃：MP消費なし
- スキル：MP消費あり

### 攻撃のサブ属性（技ごとに設定）

| サブ属性 | 値 | 説明 |
|---------|------|------|
| 射程 (range) | number | 攻撃が届くマス数。1=隣接のみ |
| 射線貫通 (piercing) | boolean | trueなら間のユニットを無視 |
| 防御貫通率 (defPen) | 0.0〜1.0 | DEFを無視する割合 |
| MP消費 (mpCost) | number | 0=通常攻撃 |
| 威力倍率 (power) | number | ATKに乗算する係数。1.0=等倍 |

### 射程の判定
- 攻撃者と対象のマンハッタン距離 ≤ 射程なら範囲内
- 射程1 = 近接（隣接マスのみ）
- 射程2以上 = 遠距離

### 射線の判定
- 射線貫通=falseの場合、攻撃者と対象を結ぶ直線上にユニットまたは岩があると遮蔽される
- 射線貫通=trueの場合、遮蔽を無視
- 射線判定のアルゴリズム：ブレゼンハムのライン or 簡易的な直線補間

### 茂みの効果
- 茂みにいるユニットは、射線貫通=falseの遠距離攻撃（射程2以上）の対象にならない
- 近接攻撃（射程1）と射線貫通=trueの攻撃は茂みを無視

### 高台の効果
- 高台にいるユニットの全攻撃の射程が+1される

### ダメージ計算

```typescript
function calcDamage(atk: number, def: number, power: number, defPen: number): number {
  const effectiveDef = def * (1 - defPen);
  const damage = atk * power * (100 / (100 + effectiveDef));
  return Math.max(1, Math.round(damage)); // 最低1ダメージ保証
}
```

### 回避判定

```typescript
function checkEvasion(eva: number): boolean {
  // EVA値をそのまま回避率(%)として扱う（暫定）
  return Math.random() * 100 < eva;
}
```

回避成功時、ダメージは0。

---

## 6. 勝利・敗北

- 敵全滅 → 勝利
- 味方全滅 → 敗北
- 戦闘不能のユニットはそのバトル中復帰しない
- 控えとの交代は戦闘中不可

---

## 7. 敵AI（MVP段階）

普通の強さ。弱すぎるとテストにならない。

### 基本方針
1. 移動可能範囲内で最も有利な位置を探す
2. 攻撃可能な対象の中からHP最低の味方を優先（集中攻撃）
3. 射程内に対象がいない場合、最も近い味方に向かって移動
4. MP管理：MPが十分ある場合はスキルを使用、不足時は通常攻撃

### 評価関数（簡易版）
```
スコア = 与ダメージ予測 - 被ダメージリスク + 位置価値
```
- 位置価値：茂みにいると+、高台にいると+、複数の敵に囲まれると-

---

## 8. カメラ制御

- **ターン時**：行動中のユニットを中心にズーム。MOV範囲+1マスが画面に収まる程度
- **全体表示**：ボタンまたはピンチアウトで盤面全体を表示
- **スクロール**：ドラッグで盤面をスクロール可能

---

## 9. 仮モンスターデータ

### 設計方針
- 4種族（獣・岩・霊・竜）から2体ずつ、計8体（味方4 + 敵4）
- 基本ロール（タンク、近接アタッカー、遠距離アタッカー、サポート）をカバー
- シンプルな性能。MVP段階では複雑なギミックは不要

### 味方モンスター（4体）

#### 1. 疾風狼（獣系・近接アタッカー）
| ステータス | 値 |
|-----------|:--:|
| HP | 80 |
| ATK | 30 |
| DEF | 15 |
| SPD | 28 |
| MP | 20 |
| EVA | 15 |
| MOV | 2 |

| 技名 | 射程 | 射線貫通 | 防御貫通率 | MP消費 | 威力倍率 |
|------|:--:|:--:|:--:|:--:|:--:|
| 噛みつき（通常） | 1 | - | 0% | 0 | 1.0 |
| 疾風斬 | 1 | - | 0% | 5 | 1.5 |
| 突進 | 2 | false | 10% | 8 | 1.2 |

#### 2. 岩甲蟹（岩系・タンク）
| ステータス | 値 |
|-----------|:--:|
| HP | 130 |
| ATK | 18 |
| DEF | 35 |
| SPD | 10 |
| MP | 15 |
| EVA | 3 |
| MOV | 1 |

| 技名 | 射程 | 射線貫通 | 防御貫通率 | MP消費 | 威力倍率 |
|------|:--:|:--:|:--:|:--:|:--:|
| 岩砕き（通常） | 1 | - | 0% | 0 | 1.0 |
| 石投げ | 2 | true | 0% | 6 | 0.8 |

#### 3. 幽灯火（霊系・遠距離アタッカー）
| ステータス | 値 |
|-----------|:--:|
| HP | 60 |
| ATK | 28 |
| DEF | 10 |
| SPD | 22 |
| MP | 40 |
| EVA | 20 |
| MOV | 2 |

| 技名 | 射程 | 射線貫通 | 防御貫通率 | MP消費 | 威力倍率 |
|------|:--:|:--:|:--:|:--:|:--:|
| 霊火（通常） | 2 | false | 0% | 0 | 1.0 |
| 鬼火弾 | 2 | false | 30% | 8 | 1.3 |
| 怨念の炎 | 3 | true | 50% | 15 | 1.5 |
| 魂の灯 | 2 | true | 0% | 10 | 0.0（味方HP20回復） |

#### 4. 仔竜（竜系・バランス型）
| ステータス | 値 |
|-----------|:--:|
| HP | 100 |
| ATK | 25 |
| DEF | 22 |
| SPD | 18 |
| MP | 30 |
| EVA | 8 |
| MOV | 2 |

| 技名 | 射程 | 射線貫通 | 防御貫通率 | MP消費 | 威力倍率 |
|------|:--:|:--:|:--:|:--:|:--:|
| 尾撃（通常） | 1 | - | 0% | 0 | 1.0 |
| 火炎ブレス | 2 | false | 20% | 10 | 1.4 |
| 竜の咆哮 | 2 | true | 40% | 15 | 1.6 |

### 敵モンスター（4体）

#### 1. 餓狼（獣系・近接アタッカー）
| ステータス | 値 |
|-----------|:--:|
| HP | 75 |
| ATK | 28 |
| DEF | 12 |
| SPD | 26 |
| MP | 15 |
| EVA | 18 |
| MOV | 2 |

| 技名 | 射程 | 射線貫通 | 防御貫通率 | MP消費 | 威力倍率 |
|------|:--:|:--:|:--:|:--:|:--:|
| 牙（通常） | 1 | - | 0% | 0 | 1.0 |
| 飛びかかり | 2 | false | 5% | 5 | 1.3 |

#### 2. 鉄壁亀（岩系・タンク）
| ステータス | 値 |
|-----------|:--:|
| HP | 140 |
| ATK | 15 |
| DEF | 38 |
| SPD | 8 |
| MP | 10 |
| EVA | 2 |
| MOV | 1 |

| 技名 | 射程 | 射線貫通 | 防御貫通率 | MP消費 | 威力倍率 |
|------|:--:|:--:|:--:|:--:|:--:|
| 頭突き（通常） | 1 | - | 0% | 0 | 1.0 |
| 岩落とし | 2 | true | 0% | 8 | 0.9 |

#### 3. 影蜘蛛（霊系・デバッファー）
| ステータス | 値 |
|-----------|:--:|
| HP | 55 |
| ATK | 22 |
| DEF | 12 |
| SPD | 24 |
| MP | 35 |
| EVA | 22 |
| MOV | 2 |

| 技名 | 射程 | 射線貫通 | 防御貫通率 | MP消費 | 威力倍率 |
|------|:--:|:--:|:--:|:--:|:--:|
| 糸針（通常） | 2 | false | 0% | 0 | 1.0 |
| 暗闘の糸 | 2 | true | 40% | 10 | 1.2 |
| 毒霧 | 2 | true | 20% | 8 | 0.8 |

#### 4. 飛竜（竜系・高機動）
| ステータス | 値 |
|-----------|:--:|
| HP | 90 |
| ATK | 26 |
| DEF | 18 |
| SPD | 20 |
| MP | 25 |
| EVA | 12 |
| MOV | 3 |

| 技名 | 射程 | 射線貫通 | 防御貫通率 | MP消費 | 威力倍率 |
|------|:--:|:--:|:--:|:--:|:--:|
| 鉤爪（通常） | 1 | - | 0% | 0 | 1.0 |
| 急降下 | 2 | false | 15% | 8 | 1.5 |
| 炎翼 | 2 | true | 30% | 12 | 1.3 |

---

## 10. UI要件（MVP段階）

### 盤面
- 6×4グリッドを画面中央に表示
- 各マスにモンスターアイコン（絵文字 or シンプルなアイコンで可）
- 地形はマスの色や記号で表現
- 選択中のユニットはハイライト
- 移動可能範囲をハイライト
- 攻撃可能範囲をハイライト（色を変える）

### HUD
- 各ユニットのHP/MPバー（盤面上に小さく表示）
- 現在の行動ユニットを目立たせる
- ターン順リスト（画面端にSPD順で表示）
- 行動選択パネル（通常攻撃・スキル一覧・待機）

### フィードバック
- ダメージ数値のポップアップ表示
- 回避時に「MISS」表示
- 戦闘不能時の表示

### 戦闘結果
- 勝利/敗北画面
- リプレイボタン（同じ構成で再戦）
- リロールボタン（地形を変えて再戦）
